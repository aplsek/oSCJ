#!/bin/bash
# This is a generated file.  It is actually generated twice.  First, by
# configure to produce a script for an uninstalled OVM build.  And
# second, by make to produce a script for an installed copy of the OVM.

print_usage()
{
  printf "This program's behavior is affected by several environment\n"
  printf "variables:\n" 
  printf "	JAVA		program used to launch java application [$JAVA]\n"
  printf "	MAKE            program used to compile code [$MAKE]\n"
  printf "	CLASSPATH	path to VM code [$CLASSPATH]\n"
  printf "	STITCHER_PATH   search path for InvisibleStitcher [$STITCHER_PATH]\n"
  printf "	STITCHER_FILE   main file for InvisibleStitcher [$STITCHER_FILE]\n"
}

JAVA=${JAVA:-@JAVA@}
MAKE=${MAKE:-@MAKE@}
AJC='@JAVA@ -Xmx700m -classpath @ABS_TOP_BUILDDIR@/build/aspectjtools.jar:@JAVA_HOME@/lib/tools.jar org.aspectj.tools.ajc.Main'
CLASSPATH=@OVM_JAR@:@ABS_TOP_BUILDDIR@/build/aspectjrt.jar${CLASSPATH+:$CLASSPATH}
STITCHER_PATH=${STITCHER_PATH:-@STITCHER_PATH@}
STITCHER_FILE=${STITCHER_FILE:-stitchery}
export CLASSPATH

if [ "$*" != "-help" -a "$*" != "-?" -a -e OVMMakefile ]; then
    $MAKE -f OVMMakefile clean
fi

# Parse the aspect option
# e.g., -aspect='../src/s3/services/transaction/Atomic.aj:../src/s3/services/transaction/AtomicWithStats.aj'
# or -aspectpath=../src
aspects=""
aspectpaths=""
for arg
do
	case "$arg"
	in
	    -aspect=*)  aspects=`echo $arg | sed 's/-aspect=//'`; ;;
	    -aspectpath=*) aspectpaths=`echo $arg | sed 's/-aspectpath=//'`; ;;
	esac
done

# Need to avoid applying aspects more than once to the same ovm.jar
if [ -f @ABS_TOP_BUILDDIR@/src/ovm_original.jar ]
then
    # Save the original ovm.jar as ovm_original.jar
    cp @ABS_TOP_BUILDDIR@/src/ovm_original.jar \
	@ABS_TOP_BUILDDIR@/src/ovm.jar
else
    # Restore the original ovm.jar from ovm_original.jar
    cp @ABS_TOP_BUILDDIR@/src/ovm.jar \
	@ABS_TOP_BUILDDIR@/src/ovm_original.jar
fi

if [ -n "$aspectpaths" -o -n "$aspects" ]
then
    aspects=`echo $aspects | sed 's/:/ /g'`
    if [ -n "$aspectpaths" ]
    then
	aspectsInPaths=""
	for path in `echo $aspectpaths | sed 's/:/ /g'`
        do
	  aspectsInPaths="$aspectsInPaths `find $path -name \"*.aj\" -printf \"%p \"`"
	done
	aspects="$aspects $aspectsInPaths"

	echo "Applying"
	echo "    $aspects"
	echo "against ovm.jar"

	$AJC -inpath @ABS_TOP_BUILDDIR@/src/ovm.jar \
	    -outjar @ABS_TOP_BUILDDIR@/src/ovm_aspect.jar \
	    -classpath @ABS_TOP_BUILDDIR@/build/aspectjrt.jar \
	    -target 1.4 \
	    -source 1.4 \
	    -g \
	    $aspects
    else
	echo "Applying"
	echo "    $aspects"
	echo "against ovm.jar"

	$AJC -inpath @ABS_TOP_BUILDDIR@/src/ovm.jar \
	    -outjar @ABS_TOP_BUILDDIR@/src/ovm_aspect.jar \
	    -classpath @ABS_TOP_BUILDDIR@/build/aspectjrt.jar \
	    -target 1.4 \
	    -source 1.4 \
	    -g \
	    $aspects
    fi
    cp @ABS_TOP_BUILDDIR@/src/ovm_aspect.jar \
	@ABS_TOP_BUILDDIR@/src/ovm.jar
fi

$JAVA -Xmx900M					\
      -Dovm.stitcher.path=$STITCHER_PATH	\
      -Dovm.stitcher.file=$STITCHER_FILE	\
      s3.services.bootimage.Driver		\
      @GEN_OVM_ARGUMENTS@			\
      "$@"					\
 && $MAKE -f OVMMakefile all

stat=$?
if [ $stat -ne 0 ]
then
    print_usage >&2
    exit $stat
fi
