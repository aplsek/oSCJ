#! /bin/bash

#
# Wrapper script for tsim-leon3 simulator. Filters out output of the
# simulated program and its return value.
#
# Assumes that the program to simulated program cooperates (see below).
# Assumes that the tsim-leon3 simulator is on PATH
#


if [ ! -x `which tsim-leon3 2>/dev/null` ] ; then
	echo "tsim-leon3 simulator not found." >&2 
	exit 2
fi	

echo go | tsim-leon3 $* | gawk '

BEGIN {
  do_write=0
  return_code=0
  program_started=0
}

/----PROGRAM-STARTS-HERE----/ {
  do_write=1
  program_started=1
  next
}  

/----PROGRAM-ENDS-HERE----.*/ {
  do_write=0
  return_code=$2
  next
}

// {
  if (do_write) {
    print
  }
}

END {
  if (!program_started) {
  	print "Program did not start or does not support this simulator wrapper."
  	exit(1)
  }
  exit(return_code)
}
'