#! /bin/bash

#
# Wrapper script for bochs simulator. Filters out output of the
# simulated program and its return value.
#
# Assumes that the program to simulated program cooperates (see below).
# Assumes that run script for bochs simulator is on PATH
#

RUNNER=/root/x86runner/run.sh

if [ ! -x $RUNNER ] ; then
	echo "Run script for bochs simulator ($RUNNER) not found." >&2 
	exit 2
fi	

echo go | $RUNNER $* 2>/dev/null | gawk '

BEGIN {
  do_write=0
  return_code=0
  program_started=0
}

/----PROGRAM-STARTS-HERE----/ {
  do_write=1
  program_started=1
  next
}  

/----PROGRAM-ENDS-HERE----.*/ {
  do_write=0
  return_code=$2
  next
}

// {
  if (do_write) {
    print
  }
}

END {
  if (!program_started) {
  	print "Program did not start or does not support this simulator wrapper."
  	exit(1)
  }
  exit(return_code)
}
'
